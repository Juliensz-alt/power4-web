<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power4 Web - Jeu Puissance 4</title>
    <link rel="stylesheet" href="/static/styles.css?v={{.CSSVersion}}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Power4 Web</h1>
            <p class="subtitle">Jeu Puissance 4 en ligne</p>
        </header>

        <main>
            <!-- √âcran de menu avant le d√©but de la partie -->
            {{if not .Started}}
            <section class="menu-screen">
                <h2>Bienvenue dans Power4</h2>
                <p class="menu-subtitle">Pr√©parez-vous pour une partie de Puissance 4 !</p>

                <div class="menu-actions">
                    <!-- Avant de choisir le mode (duo/bot) on choisit d'abord la variante
                         (Puissance 4 ou Puissance 5). Le bouton 'Jouer' m√®ne √† la page
                         de s√©lection de la variante. -->
                    <a href="/variant" class="btn btn-play">‚ñ∂ Jouer</a>
                </div>

                <div class="menu-extra-actions">
                    <a href="/rules" class="btn btn-secondary"> R√®gles</a>
                    <a href="/blank" class="btn btn-secondary"> Page vide</a>
                </div>

                <p class="menu-hint"> </p>
            </section>
            {{end}}

            <!-- Informations du jeu -->
            <div class="game-info {{if not .Started}}hidden{{end}}">
                <div class="current-player">
                    <span class="label">Joueur actuel :</span>
                    <span class="player-indicator player-{{.CurrentPlayer}}">
                        Joueur {{.CurrentPlayer}}
                    </span>
                </div>
                <div class="game-status">
                    <span class="status-message">{{.Message}}</span>
                </div>
            </div>

            <!-- Plateau de jeu -->
            <div class="game-board {{if not .Started}}hidden{{end}}">
                <table class="board-table">
                    {{range $rowIndex, $row := .Board}}
                    <tr>
                        {{range $colIndex, $col := $row}}
                        <td class="cell {{if eq $col 1}}player-1{{else if eq $col 2}}player-2{{end}}" 
                            data-column="{{$colIndex}}">
                            {{if eq $col 1}}
                                    <div class="token"></div>
                                {{else if eq $col 2}}
                                    <div class="token"></div>
                                {{else}}
                                    <div class="token empty"></div>
                                {{end}}
                        </td>
                        {{end}}
                    </tr>
                    {{end}}
                </table>
            </div>

            <!-- Actions secondaires (sans boutons de colonnes) -->
            <div class="action-buttons {{if not .Started}}hidden{{end}}">
                <a href="/" class="btn btn-secondary">Actualiser</a>
                <form action="/quit" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-secondary">Retour au menu</button>
                </form>
                <form action="/reset" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-primary">Nouvelle partie</button>
                </form>
            </div>

            <!-- Informations des joueurs -->
            <div class="players-info {{if not .Started}}hidden{{end}}">
                <div class="player-info player-1">
                    <div class="player-token">‚óè</div>
                    <span>{{.Player1Name}}</span>
                </div>
                <div class="player-info player-2">
                    <div class="player-token">‚óè</div>
                    <span>{{.Player2Name}}</span>
                </div>
            </div>

            <!-- Notification de fin de partie (remplace le bandeau en bas) -->
            <!-- Utilise les attributs data-* pour que le JS puisse d√©cider d'afficher
                 la notification apr√®s le rendu c√¥t√© serveur. -->
            <div id="game-notification" class="notification hidden" role="dialog" aria-live="assertive"
                 data-gameover="{{.GameOver}}" data-winner="{{.Winner}}" data-message="{{.Message}}">
                <div class="notification-content">
                    <button class="notification-close" aria-label="Fermer">&times;</button>
                    <h2 class="notification-title"></h2>
                    <p class="notification-body"></p>
                    <div class="notification-actions">
                        <form action="/reset" method="POST" style="display:inline; margin-right:8px;">
                            <button type="submit" class="btn btn-primary">Nouvelle partie</button>
                        </form>
                        <form action="/quit" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-secondary">Retour au menu</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>Power4 Web - D√©velopp√© avec Go et HTML Templates</p>
        </footer>
    </div>
    <script>
        // Clique sur une cellule pour jouer dans la colonne correspondante
        document.querySelectorAll('.board-table td').forEach(cell => {
            cell.addEventListener('click', () => {
                const column = cell.dataset.column;
                if (!column) return;

                // Cr√©e et envoie dynamiquement un formulaire POST √† /play
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/play';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'column';
                input.value = parseInt(column) + 1; // colonnes 1 √† 7
                form.appendChild(input);

                document.body.appendChild(form);
                form.submit();
            });
        });

        // Effet de survol (highlight de la colonne)
        document.querySelectorAll('.board-table td').forEach(cell => {
            cell.addEventListener('mouseenter', () => {
                const column = cell.dataset.column;
                const cells = document.querySelectorAll(`.board-table tr td:nth-child(${parseInt(column) + 1})`);
                cells.forEach(c => c.classList.add('highlight'));
            });
            cell.addEventListener('mouseleave', () => {
                const column = cell.dataset.column;
                const cells = document.querySelectorAll(`.board-table tr td:nth-child(${parseInt(column) + 1})`);
                cells.forEach(c => c.classList.remove('highlight'));
            });
        });
    </script>
    <script>
        // Notification de fin de partie : affiche un modal/toast si data-gameover vaut true
        (function() {
            const notif = document.getElementById('game-notification');
            if (!notif) return;

            // Les attributs data-* sont rendus c√¥t√© serveur
            const isOver = notif.dataset.gameover === 'true' || notif.dataset.gameover === '1';
            const winner = parseInt(notif.dataset.winner) || 0;
            const message = notif.dataset.message || '';

            const titleEl = notif.querySelector('.notification-title');
            const bodyEl = notif.querySelector('.notification-body');
            const closeBtn = notif.querySelector('.notification-close');

            function showNotification() {
                // Remplir le contenu selon le r√©sultat
                if (winner && winner > 0) {
                    titleEl.textContent = 'üéâ F√©licitations !';
                    bodyEl.textContent = 'Le Joueur ' + winner + ' a gagn√© !';
                } else if (message && message.indexOf('Match nul') !== -1) {
                    titleEl.textContent = 'ü§ù Match nul !';
                    bodyEl.textContent = 'La grille est pleine, personne n\'a gagn√©.';
                } else if (message) {
                    titleEl.textContent = '';
                    bodyEl.textContent = message;
                } else {
                    titleEl.textContent = 'Fin de la partie';
                    bodyEl.textContent = '';
                }

                notif.classList.remove('hidden');
                notif.classList.add('visible');
                // focus sur le bouton fermer pour accessibilit√©
                if (closeBtn) closeBtn.focus();
            }

            function hideNotification() {
                notif.classList.remove('visible');
                notif.classList.add('hidden');
            }

            if (isOver) {
                // Laisser un court delay pour que la page soit enti√®rement visible
                setTimeout(showNotification, 80);
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', hideNotification);
            }
        })();
    </script>
</body>
</html>
